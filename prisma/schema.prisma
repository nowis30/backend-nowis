generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int         @id @default(autoincrement())
  email        String      @unique
  passwordHash String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  properties   Property[]
  companies    Company[]
  shareholders Shareholder[]
  roles        UserRole[]
  leveragedBuybackScenarios LeveragedBuybackScenario[]
  rentalTaxStatements      RentalTaxStatement[]
  valuationSnapshots       ValuationSnapshot[]
  personalAssets           PersonalAsset[]
  personalLiabilities      PersonalLiability[]
  personalExpenses         PersonalExpense[]
  familyTrusts             FamilyTrust[]
  familyWealthSnapshots    FamilyWealthSnapshot[]
  familyWealthScenarios    FamilyWealthScenario[]
  freezeAssets             FreezeAsset[]
  freezeScenarios          FreezeScenario[]
  freezeSimulations        FreezeSimulation[]
  investmentAccounts       InvestmentAccount[]
  financialGoals           FinancialGoal[]
  leverageScenarios        LeverageScenario[]
  advisorConversations     AdvisorConversation[]
}

model Property {
  id               Int                  @id @default(autoincrement())
  userId           Int
  companyId        Int?
  name             String
  address          String?
  acquisitionDate  DateTime?
  purchasePrice    Decimal?
  currentValue     Decimal?
  notes            String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  user             User                  @relation(fields: [userId], references: [id])
  company          Company?              @relation(fields: [companyId], references: [id], onDelete: SetNull)
  units            PropertyUnit[]
  mortgages        Mortgage[]
  revenues         Revenue[]
  expenses         Expense[]
  invoices         Invoice[]
  depreciationInfo DepreciationSetting?
  attachments      Attachment[]
  rentalTaxStatements RentalTaxStatement[]
  freezeAssets       FreezeAsset[]
}

model Company {
  id            Int                     @id @default(autoincrement())
  userId        Int
  name          String
  neq           String?
  fiscalYearEnd DateTime?
  province      String?
  notes         String?
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt

  user               User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  properties         Property[]
  shareholderLinks   CompanyShareholder[]
  shareClasses       ShareClass[]
  shareTransactions  ShareTransaction[]
  statements         CorporateStatement[]
  resolutions        CorporateResolution[]
  userRoles          UserRole[]
  dividends          DividendDeclaration[]
  returnsOfCapital   ReturnOfCapitalRecord[]
  shareholderLoans   ShareholderLoan[]
  corporateTaxReturns CorporateTaxReturn[]
  leveragedBuybackScenarios LeveragedBuybackScenario[]
  valuationSnapshots       ValuationSnapshot[]
  freezeAssets             FreezeAsset[]
  leverageScenarios        LeverageScenario[]
}

model Shareholder {
  id            Int                  @id @default(autoincrement())
  userId        Int
  type          String               @default("PERSON")
  displayName   String
  contactEmail  String?
  contactPhone  String?
  notes         String?
  lifetimeCapitalGainsExemptionRemaining Decimal?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  user              User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  companies         CompanyShareholder[]
  shareTransactions ShareTransaction[]
  dividends         DividendDeclaration[]
  returnsOfCapital  ReturnOfCapitalRecord[]
  shareholderLoans  ShareholderLoan[]
  personalTaxReturns PersonalTaxReturn[]
  personalIncomes   PersonalIncome[]
  familyTrust       FamilyTrust?
  familyTrustBeneficiaries FamilyTrustBeneficiary[]
}

model CompanyShareholder {
  id             Int          @id @default(autoincrement())
  companyId      Int
  shareholderId  Int
  role           String?
  votingPercent  Decimal?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  shareholder Shareholder @relation(fields: [shareholderId], references: [id], onDelete: Cascade)

}

model ShareClass {
  id                     Int                 @id @default(autoincrement())
  companyId              Int
  code                   String
  description            String?
  hasVotingRights        Boolean             @default(true)
  participatesInGrowth   Boolean             @default(true)
  dividendPolicy         String?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt

  company        Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions   ShareTransaction[]
  dividends      DividendDeclaration[]
  returnsOfCapital ReturnOfCapitalRecord[]

}

model ShareTransaction {
  id                Int                   @id @default(autoincrement())
  companyId         Int
  shareClassId      Int
  shareholderId     Int
  type              String
  transactionDate   DateTime
  quantity          Decimal
  pricePerShare     Decimal?
  considerationPaid Decimal?
  fairMarketValue   Decimal?
  notes             String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  shareClass  ShareClass  @relation(fields: [shareClassId], references: [id], onDelete: Cascade)
  shareholder Shareholder @relation(fields: [shareholderId], references: [id], onDelete: Cascade)
}

model CorporateStatement {
  id               Int                    @id @default(autoincrement())
  companyId        Int
  statementType    String
  periodStart      DateTime
  periodEnd        DateTime
  isAudited        Boolean                @default(false)
  totalAssets      Decimal                @default(0)
  totalLiabilities Decimal                @default(0)
  totalEquity      Decimal                @default(0)
  totalRevenue     Decimal                @default(0)
  totalExpenses    Decimal                @default(0)
  netIncome        Decimal                @default(0)
  metadata         String?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt

  company Company                   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lines   CorporateStatementLine[]
}

model CorporateStatementLine {
  id          Int                   @id @default(autoincrement())
  statementId Int
  category    String
  label       String
  amount      Decimal
  orderIndex  Int                   @default(0)
  metadata    String?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  statement CorporateStatement @relation(fields: [statementId], references: [id], onDelete: Cascade)
}

model CorporateResolution {
  id             Int            @id @default(autoincrement())
  companyId      Int
  type           String
  title          String
  resolutionDate DateTime
  body           String?
  metadata       String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

enum DividendType {
  ELIGIBLE
  NON_ELIGIBLE
}

model DividendDeclaration {
  id               Int            @id @default(autoincrement())
  companyId        Int
  shareholderId    Int
  shareClassId     Int?
  declarationDate  DateTime
  recordDate       DateTime?
  paymentDate      DateTime?
  amount           Decimal
  dividendType     DividendType
  grossUpRate      Decimal         @default(0)
  grossedAmount    Decimal         @default(0)
  federalCredit    Decimal         @default(0)
  provincialCredit Decimal         @default(0)
  notes            String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  shareholder Shareholder @relation(fields: [shareholderId], references: [id], onDelete: Cascade)
  shareClass  ShareClass? @relation(fields: [shareClassId], references: [id], onDelete: SetNull)
}

model ReturnOfCapitalRecord {
  id              Int            @id @default(autoincrement())
  companyId       Int
  shareholderId   Int
  shareClassId    Int?
  transactionDate DateTime
  amount          Decimal
  previousAcb     Decimal?
  newAcb          Decimal?
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  shareholder Shareholder @relation(fields: [shareholderId], references: [id], onDelete: Cascade)
  shareClass  ShareClass? @relation(fields: [shareClassId], references: [id], onDelete: SetNull)
}

model ShareholderLoan {
  id             Int                         @id @default(autoincrement())
  companyId      Int
  shareholderId  Int
  issuedDate     DateTime
  principal      Decimal
  interestRate   Decimal
  interestMethod String                     @default("SIMPLE")
  dueDate        DateTime?
  notes          String?
  createdAt      DateTime                    @default(now())
  updatedAt      DateTime                    @updatedAt

  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  shareholder Shareholder @relation(fields: [shareholderId], references: [id], onDelete: Cascade)
  payments    ShareholderLoanPayment[]
}

model ShareholderLoanPayment {
  id           Int             @id @default(autoincrement())
  loanId       Int
  paymentDate  DateTime
  principalPaid Decimal        @default(0)
  interestPaid Decimal         @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  loan ShareholderLoan @relation(fields: [loanId], references: [id], onDelete: Cascade)
}

model CorporateTaxReturn {
  id                    Int       @id @default(autoincrement())
  companyId             Int
  fiscalYearEnd         DateTime
  netIncome             Decimal   @default(0)
  taxableIncome         Decimal   @default(0)
  smallBusinessDeduction Decimal  @default(0)
  federalTax            Decimal   @default(0)
  provincialTax         Decimal   @default(0)
  rdtohOpening          Decimal   @default(0)
  rdtohClosing          Decimal   @default(0)
  gripOpening           Decimal   @default(0)
  gripClosing           Decimal   @default(0)
  cdaOpening            Decimal   @default(0)
  cdaClosing            Decimal   @default(0)
  refunds               Decimal   @default(0)
  notes                 String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, fiscalYearEnd])
}

model PersonalTaxReturn {
  id                       Int       @id @default(autoincrement())
  shareholderId            Int
  taxYear                  Int
  employmentIncome         Decimal   @default(0)
  businessIncome           Decimal   @default(0)
  eligibleDividends        Decimal   @default(0)
  nonEligibleDividends     Decimal   @default(0)
  capitalGains             Decimal   @default(0)
  deductions               Decimal   @default(0)
  otherCredits             Decimal   @default(0)
  taxableIncome            Decimal   @default(0)
  federalTax               Decimal   @default(0)
  provincialTax            Decimal   @default(0)
  totalCredits             Decimal   @default(0)
  balanceDue               Decimal   @default(0)
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  shareholder Shareholder @relation(fields: [shareholderId], references: [id], onDelete: Cascade)

  @@unique([shareholderId, taxYear])
}

model PersonalIncome {
  id            Int       @id @default(autoincrement())
  shareholderId Int
  taxYear       Int
  category      String
  label         String
  source        String?
  slipType      String?
  amount        Decimal   @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  shareholder Shareholder @relation(fields: [shareholderId], references: [id], onDelete: Cascade)

  @@index([shareholderId, taxYear])
}

model PersonalAsset {
  id          Int      @id @default(autoincrement())
  userId      Int
  label       String
  category    String?
  ownerType   String    @default("PERSONAL")
  ownerNotes  String?
  valuation   Decimal   @default(0)
  valuationDate DateTime
  liquidityTag String?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, valuationDate])
}

model PersonalLiability {
  id          Int      @id @default(autoincrement())
  userId      Int
  label       String
  category    String?
  counterparty String?
  balance     Decimal   @default(0)
  interestRate Decimal? 
  maturityDate DateTime?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PersonalExpense {
  id          Int      @id @default(autoincrement())
  userId      Int
  label       String
  category    String?
  amount      Decimal   @default(0)
  frequency   String    @default("MONTHLY")
  startDate   DateTime?
  endDate     DateTime?
  essential   Boolean   @default(false)
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, category])
}

model FamilyTrust {
  id             Int       @id @default(autoincrement())
  userId         Int
  shareholderId  Int?      @unique
  name           String
  establishedOn  DateTime?
  netAssetValue  Decimal   @default(0)
  mandate        String?
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  shareholder Shareholder? @relation(fields: [shareholderId], references: [id], onDelete: SetNull)
  fiduciaries FamilyTrustFiduciary[]
  beneficiaries FamilyTrustBeneficiary[]
  freezeScenarios FreezeScenario[]

  @@index([userId])
}

model FamilyTrustFiduciary {
  id        Int       @id @default(autoincrement())
  trustId   Int
  fullName  String
  role      String?
  email     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  trust FamilyTrust @relation(fields: [trustId], references: [id], onDelete: Cascade)

  @@index([trustId])
}

model FamilyTrustBeneficiary {
  id         Int        @id @default(autoincrement())
  trustId    Int
  shareholderId Int?
  displayName String
  relationship String?
  birthDate   DateTime?
  preferredAllocationPercent Decimal?
  lifetimeCapitalGainsExemptionClaimed Decimal?
  notes       String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  trust       FamilyTrust @relation(fields: [trustId], references: [id], onDelete: Cascade)
  shareholder Shareholder? @relation(fields: [shareholderId], references: [id], onDelete: SetNull)
  simulationResults FreezeSimulationBeneficiaryResult[]

  @@index([trustId])
  @@index([shareholderId])
}

model FamilyWealthSnapshot {
  id                   Int      @id @default(autoincrement())
  userId               Int
  snapshotDate         DateTime
  totalAssets          Decimal   @default(0)
  totalLiabilities     Decimal   @default(0)
  netWorth             Decimal   @default(0)
  propertyValue        Decimal   @default(0)
  companyValue         Decimal   @default(0)
  trustValue           Decimal   @default(0)
  personalAssetsValue  Decimal   @default(0)
  liquidAssetsValue    Decimal   @default(0)
  personalDebtValue    Decimal   @default(0)
  shareholderLoanValue Decimal   @default(0)
  metadata             Json?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, snapshotDate])
  @@index([userId, snapshotDate])
}

model FamilyWealthScenario {
  id          Int      @id @default(autoincrement())
  userId      Int
  label       String
  scenarioType String   @default("BASELINE")
  parameters  Json?
  results     Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, scenarioType])

}

enum LeverageSourceType {
  HOME_EQUITY
  RENTAL_PROPERTY
  HELOC
  CORPORATE_LOAN
}

enum LeverageInvestmentVehicle {
  ETF
  STOCK
  REALESTATE
  BUSINESS
  FUND
}

model LeverageScenario {
  id                  Int                        @id @default(autoincrement())
  userId              Int
  companyId           Int?
  label               String
  sourceType          LeverageSourceType
  principal           Decimal                     @db.Decimal(18, 2)
  rateAnnual          Decimal                     @db.Decimal(5, 4)
  termMonths          Int
  amortizationMonths  Int?
  startDate           DateTime
  interestDeductible  Boolean                     @default(false)
  investmentVehicle   LeverageInvestmentVehicle
  expectedReturnAnnual Decimal                    @db.Decimal(5, 4)
  expectedVolatility  Decimal?                    @db.Decimal(5, 4)
  planHorizonYears    Int                         @default(10)
  notes               String?
  createdAt           DateTime                    @default(now())
  updatedAt           DateTime                    @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([companyId])
}

enum AdvisorExpert {
  FISCALISTE
  COMPTABLE
  PLANIFICATEUR
  AVOCAT
}

enum AdvisorConversationRole {
  USER
  ASSISTANT
}

enum AdvisorConversationStatus {
  ACTIVE
  COMPLETED
}

model AdvisorConversation {
  id        Int                       @id @default(autoincrement())
  userId    Int
  expert    AdvisorExpert
  status    AdvisorConversationStatus @default(ACTIVE)
  createdAt DateTime                  @default(now())
  updatedAt DateTime                  @updatedAt

  user  User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  steps AdvisorConversationStep[]

  @@index([userId])
  @@index([userId, expert])
}

model AdvisorConversationStep {
  id             Int                    @id @default(autoincrement())
  conversationId Int
  role           AdvisorConversationRole
  message        String
  snapshot       Json?
  updates        Json?
  nextQuestion   Json?
  completed      Boolean?
  createdAt      DateTime               @default(now())

  conversation AdvisorConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model FreezeAsset {
  id                        Int        @id @default(autoincrement())
  userId                    Int
  label                     String
  assetType                 String     @default("PROPERTY")
  fairMarketValue           Decimal    @default(0)
  adjustedCostBase          Decimal    @default(0)
  annualGrowthPercent       Decimal    @default(0)
  distributionYieldPercent  Decimal    @default(0)
  associatedDebt            Decimal?
  companyId                 Int?
  propertyId                Int?
  notes                     String?
  createdAt                 DateTime   @default(now())
  updatedAt                 DateTime   @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  company   Company?  @relation(fields: [companyId], references: [id], onDelete: SetNull)
  property  Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  scenarios FreezeScenarioAsset[]

  @@index([userId])
  @@index([companyId])
  @@index([propertyId])
}

model FreezeScenario {
  id                          Int       @id @default(autoincrement())
  userId                      Int
  trustId                     Int?
  label                       String
  baseYear                    Int
  freezeRatePercent           Decimal   @default(0)
  preferredDividendRatePercent Decimal  @default(0)
  redemptionYears             Int       @default(20)
  notes                       String?
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime  @updatedAt

  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  trust   FamilyTrust? @relation(fields: [trustId], references: [id], onDelete: SetNull)
  assets  FreezeScenarioAsset[]
  simulations FreezeSimulation[]

  @@index([userId])
  @@index([trustId])
}

model FreezeScenarioAsset {
  id          Int              @id @default(autoincrement())
  scenarioId  Int
  assetId     Int
  inclusionPercent Decimal     @default(100)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  scenario FreezeScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  asset    FreezeAsset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([scenarioId, assetId])
  @@index([assetId])
}

model FreezeSimulation {
  id                        Int       @id @default(autoincrement())
  userId                    Int
  scenarioId                Int
  targetFreezeYear          Int
  generations               Int
  reinvestmentRatePercent   Decimal   @default(0)
  marginalTaxRatePercent    Decimal   @default(0)
  dividendRetentionPercent  Decimal   @default(0)
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt

  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  scenario   FreezeScenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  result     FreezeSimulationResult?
  beneficiaryResults FreezeSimulationBeneficiaryResult[]
  redemptions FreezeSimulationRedemption[]
  dividends   FreezeSimulationDividend[]

  @@index([userId])
  @@index([scenarioId])
}

model FreezeSimulationResult {
  id                       Int       @id @default(autoincrement())
  simulationId             Int       @unique
  preferredShareValue      Decimal   @default(0)
  capitalGainTriggered     Decimal   @default(0)
  capitalGainTax           Decimal   @default(0)
  totalDividends           Decimal   @default(0)
  totalAfterTaxRetained    Decimal   @default(0)
  latentTaxBefore          Decimal   @default(0)
  latentTaxAfter           Decimal   @default(0)
  notes                    Json?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  simulation FreezeSimulation @relation(fields: [simulationId], references: [id], onDelete: Cascade)
}

model FreezeSimulationBeneficiaryResult {
  id               Int        @id @default(autoincrement())
  simulationId     Int
  beneficiaryId    Int?
  beneficiaryName  String
  cumulativeValue  Decimal    @default(0)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  simulation  FreezeSimulation      @relation(fields: [simulationId], references: [id], onDelete: Cascade)
  beneficiary FamilyTrustBeneficiary? @relation(fields: [beneficiaryId], references: [id], onDelete: SetNull)

  @@index([simulationId])
  @@index([beneficiaryId])
}

model FreezeSimulationRedemption {
  id           Int       @id @default(autoincrement())
  simulationId Int
  year         Int
  outstanding  Decimal   @default(0)
  redeemed     Decimal   @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  simulation FreezeSimulation @relation(fields: [simulationId], references: [id], onDelete: Cascade)

  @@index([simulationId])
}

model FreezeSimulationDividend {
  id                 Int       @id @default(autoincrement())
  simulationId       Int
  year               Int
  amount             Decimal   @default(0)
  taxableAmount      Decimal   @default(0)
  afterTaxRetained   Decimal   @default(0)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  simulation FreezeSimulation @relation(fields: [simulationId], references: [id], onDelete: Cascade)

  @@index([simulationId])
}

model InvestmentAccount {
  id             Int                    @id @default(autoincrement())
  userId         Int
  label          String
  accountType    String                 @default("TAXABLE")
  institution    String?
  accountNumber  String?
  currency       String                 @default("CAD")
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  user          User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  holdings      InvestmentHolding[]
  transactions  InvestmentTransaction[]

  @@index([userId, accountType])
}

model InvestmentHolding {
  id               Int                  @id @default(autoincrement())
  accountId        Int
  symbol           String
  description      String?
  quantity         Decimal              @default(0)
  bookValue        Decimal              @default(0)
  marketValue      Decimal              @default(0)
  currency         String               @default("CAD")
  targetAllocation Decimal?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  account       InvestmentAccount      @relation(fields: [accountId], references: [id], onDelete: Cascade)
  transactions  InvestmentTransaction[]

  @@index([accountId, symbol])
}

model InvestmentTransaction {
  id              Int                 @id @default(autoincrement())
  accountId       Int
  holdingId       Int?
  transactionType String
  symbol          String
  tradeDate       DateTime
  quantity        Decimal
  price           Decimal
  fees            Decimal              @default(0)
  notes           String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  account InvestmentAccount   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  holding InvestmentHolding?  @relation(fields: [holdingId], references: [id], onDelete: SetNull)

  @@index([accountId, tradeDate])
  @@index([holdingId])
}

model FinancialGoal {
  id            Int       @id @default(autoincrement())
  userId        Int
  name          String
  goalType      String    @default("GENERAL")
  targetAmount  Decimal   @default(0)
  targetDate    DateTime?
  priority      Int       @default(3)
  status        String    @default("ACTIVE")
  description   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user      User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  progress  FinancialGoalProgress[]

  @@index([userId, status])
}

model FinancialGoalProgress {
  id           Int       @id @default(autoincrement())
  goalId       Int
  progressDate DateTime  @default(now())
  amount       Decimal   @default(0)
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  goal FinancialGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@index([goalId, progressDate])
}

model PropertyUnit {
  id         Int      @id @default(autoincrement())
  propertyId Int
  label      String
  squareFeet Int?
  rentExpected Decimal?
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}

model Mortgage {
  id              Int       @id @default(autoincrement())
  propertyId      Int
  lender          String
  principal       Decimal
  rateAnnual      Decimal
  termMonths      Int
  amortizationMonths Int
  startDate       DateTime
  paymentFrequency Int      // nombre de paiements par an
  paymentAmount   Decimal
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  property        Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  attachments     Attachment[]
}

model Revenue {
  id         Int       @id @default(autoincrement())
  propertyId Int
  label      String
  amount     Decimal
  frequency  String    @default("MENSUEL")
  startDate  DateTime
  endDate    DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  property   Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}

model Expense {
  id         Int       @id @default(autoincrement())
  propertyId Int
  label      String
  category   String
  amount     Decimal
  frequency  String    @default("MENSUEL")
  startDate  DateTime
  endDate    DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  property   Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}

model Invoice {
  id          Int           @id @default(autoincrement())
  propertyId  Int
  invoiceDate DateTime
  supplier    String
  amount       Decimal
  category    String
  gst         Decimal?
  qst         Decimal?
  description String?
  status      String        @default("DRAFT")
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  property    Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  items       InvoiceItem[]
}

model InvoiceItem {
  id        Int      @id @default(autoincrement())
  invoiceId Int
  label     String
  amount    Decimal
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model DepreciationSetting {
  id             Int      @id @default(autoincrement())
  propertyId     Int      @unique
  classCode      String
  ccaRate        Decimal
  openingUcc     Decimal
  additions      Decimal
  dispositions   Decimal
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  property       Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
}


model Role {
  id        Int    @id @default(autoincrement())
  name      String @unique // 'ADMIN', 'COLLAB', 'INVITE'
  users     UserRole[]
}

model UserRole {
  id        Int    @id @default(autoincrement())
  userId    Int
  roleId    Int
  companyId Int?

  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, companyId], name: "userId_roleId_companyId")
}

model Attachment {
  id          Int       @id @default(autoincrement())
  propertyId  Int
  mortgageId  Int?
  title       String
  filename    String
  contentType String
  size        Int
  storagePath String
  checksum    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  mortgage Mortgage? @relation(fields: [mortgageId], references: [id], onDelete: SetNull)
}

model LeveragedBuybackScenario {
  id                    Int       @id @default(autoincrement())
  userId                Int
  companyId             Int?
  label                 String?
  loanAmount            Decimal
  interestRate          Decimal
  taxRate               Decimal
  expectedGrowth        Decimal
  termMonths            Int
  monthlyPayment        Decimal
  totalInterest         Decimal
  afterTaxInterest      Decimal
  taxShield             Decimal
  projectedShareValue   Decimal
  projectedShareGain    Decimal
  netGain               Decimal
  breakEvenGrowth       Decimal
  returnOnInvestment    Decimal
  paybackYears          Decimal?
  approved              Boolean   @default(false)
  notes                 String?
  generatedAt           DateTime  @default(now())
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([companyId])
}

enum RentalTaxFormType {
  T776
  TP128
}

model RentalTaxStatement {
  id          Int               @id @default(autoincrement())
  userId      Int
  propertyId  Int?
  formType    RentalTaxFormType
  taxYear     Int
  payload     Json
  computed    Json
  notes       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  property Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  @@index([userId, taxYear])
  @@index([userId, formType, taxYear])
  @@index([propertyId, taxYear])
}

model ValuationSnapshot {
  id                Int       @id @default(autoincrement())
  userId            Int
  companyId         Int?
  valuationDate     DateTime
  totals            Json
  properties        Json
  shareClasses      Json
  shareholderEquity Json
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@index([userId, valuationDate])
  @@index([companyId, valuationDate])
}
